@using OpsMax.ViewModels
@model CollectionCreateViewModel

@{
    ViewData["Title"] = "Collect Invoice";
    bool isLocked = TempData["LockMessage"] != null;
}

<!-- ================= ALERTS ================= -->
@if (isLocked)
{
    <script>
        alert("@TempData["LockMessage"]");
    </script>

    <div class="alert alert-warning">
        @TempData["LockMessage"]
    </div>
}

@if (TempData["CollectedWarning"] != null)
{
    <script>
        alert("@TempData["CollectedWarning"]");
    </script>
}

<!-- ================= SEARCH FORM ================= -->
<form asp-action="SearchInvoice" method="post" class="mb-4">
    @Html.AntiForgeryToken()

    <div class="row align-items-end">
        <div class="col-md-4">
            <label asp-for="InvoiceNumber" class="form-label">Invoice Number</label>
            <input asp-for="InvoiceNumber" class="form-control" />
            <span asp-validation-for="InvoiceNumber" class="text-danger"></span>
        </div>

        <div class="col-md-2">
            <button type="submit" class="btn btn-info">Search Invoice</button>
        </div>
    </div>
</form>

@if (Model?.Lines != null && Model.Lines.Any())
{
    <!-- ================= SAVE COLLECTION FORM ================= -->
    <form asp-action="Save" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()

        <!-- ================= HEADER ================= -->
        <fieldset>
            <legend>Invoice Information</legend>

            <input type="hidden" asp-for="InvoiceNumberID" />
            <input type="hidden" asp-for="CustomerID" />

            <div class="row">
                <div class="col-md-4">
                    <label>Invoice Number:</label>
                    <input asp-for="InvoiceNumber" class="form-control" readonly />
                </div>

                <div class="col-md-4">
                    <label>Customer:</label>
                    <input asp-for="CustomerName" class="form-control" readonly />
                </div>

                <div class="col-md-4">
                    <label>Invoice Date: </label>
                    <input asp-for="InvoiceDate" class="form-control" readonly />
                </div>
            </div>
        </fieldset>

        <!-- ================= LINE ITEMS ================= -->
        <fieldset class="mt-4">
            <legend>Items Collected</legend>

            <table class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Item</th>
                        <th class="text-end">Warehouse</th>
                        <th class="text-end">Qty Purchased</th>
                        <th class="text-end">Qty Collected</th>
                        <th class="text-end">Balance</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Lines.Count; i++)
                    {
                        <tr>
                            <td>
                                @Model.Lines[i].ItemCode
                                <input type="hidden" asp-for="Lines[i].ItemCodeID" />
                                <input type="hidden" asp-for="Lines[i].ItemCode" />
                                <input type="hidden" asp-for="Lines[i].ItemDescription" />
                                <input type="hidden" asp-for="Lines[i].Warehouse" />
                            </td>

                            <td class="text-end">@Model.Lines[i].Warehouse</td>

                            <td class="text-end">
                                @Model.Lines[i].QtyPurchased
                                <input type="hidden" asp-for="Lines[i].QtyPurchased" class="qty-purchased" />
                                <input type="hidden" asp-for="Lines[i].UnitPrice" />
                                <input type="hidden" asp-for="Lines[i].LineTotal" />
                            </td>

                            <td>
                                @if (isLocked)
                                {
                                    <input asp-for="Lines[i].QtyCollected"
                                           class="form-control form-control-sm text-end"
                                           readonly />
                                }
                                else
                                {
                                    <input asp-for="Lines[i].QtyCollected"
                                           class="form-control form-control-sm text-end qty-collected"
                                           type="number"
                                           min="0"
                                           step="0.01" />
                                }

                                <span asp-validation-for="Lines[i].QtyCollected"
                                      class="text-danger"></span>
                            </td>

                            <td>
                                <input asp-for="Lines[i].OrderBalance"
                                       class="form-control form-control-sm text-end order-balance"
                                       readonly />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </fieldset>

        <!-- ================= COLLECTION DETAILS ================= -->
        <fieldset class="mt-4">
            <legend>Collection Details</legend>

            <div class="row">
                <div class="col-md-4">
                    <label>Collected by: </label>
                    <input asp-for="Driver" class="form-control" readonly="@isLocked" />
                </div>

                <div class="col-md-4">
                    <label>Phone Number: </label>
                    <input asp-for="PhoneNumber" class="form-control" readonly="@isLocked" />
                </div>

                <div class="col-md-4">
                    <label>Vehicle Reg: </label>
                    <input asp-for="VehicleReg" class="form-control" readonly="@isLocked" />
                </div>
            </div>

            <div class="mt-3">
                <label>Order Notes</label>
                <textarea asp-for="OrderNotes"
                          class="form-control"
                          rows="3"
                          readonly="@isLocked"></textarea>
            </div>

            <!-- ================= POD ATTACHMENT ================= -->
            <div class="row mt-3">
                <div class="col-md-4">
                    <label>Attach POD Document</label>
                    <input asp-for="Attachment"
                           type="file"
                           class="form-control"
                           accept=".pdf,.jpg,.jpeg,.png"
                           disabled="@isLocked" />
                </div>
            </div>
        </fieldset>

        <button type="submit"
                class="btn btn-primary mt-4"
                disabled="@isLocked">
            Save Collection
        </button>
    </form>
}

@section Scripts {
    <script>
        document.addEventListener("input", function (e) {
            if (!e.target.classList.contains("qty-collected")) return;

            const row = e.target.closest("tr");
            const qtyPurchased = parseFloat(row.querySelector(".qty-purchased")?.value) || 0;
            const qtyCollected = parseFloat(e.target.value) || 0;
            const balanceInput = row.querySelector(".order-balance");

            if (balanceInput) {
                balanceInput.value = (qtyPurchased - qtyCollected).toFixed(2);
            }
        });
    </script>
}
