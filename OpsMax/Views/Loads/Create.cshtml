using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using OpsMax.Data;
using OpsMax.Models;
using OpsMax.ViewModels;
using System;
using System.Threading.Tasks;

namespace OpsMax.Controllers
{
    public class LoadController : Controller
    {
        private readonly ApplicationDbContext _context;

        public LoadController(ApplicationDbContext context)
        {
            _context = context;
        }

        // GET: Load/Create
        public async Task<IActionResult>
    Create()
    {
    var viewModel = new LoadCreateViewModel
    {
    Load = new Load()
    };

    await PopulateDropdowns(viewModel);
    return View(viewModel);
    }

    // POST: Load/Create
    [HttpPost]
    [ValidateAntiForgeryToken]
    public async Task<IActionResult>
        Create(LoadCreateViewModel viewModel)
        {
        if (!ModelState.IsValid)
        {
        await PopulateDropdowns(viewModel);
        return View(viewModel);
        }

        var load = viewModel.Load;

        // Validate all dropdowns selected
        if (load.DCLink == 0 || load.StockLink == 0 || load.idTruck == 0 || load.idDriver == 0)
        {
        ModelState.AddModelError("", "All dropdowns must be selected.");
        await PopulateDropdowns(viewModel);
        return View(viewModel);
        }

        // Calculate shortage
        load.ShortageQuantity = load.LoadedQuantity - load.ActualQuantity;

        // Audit
        load.CreatedBy = User?.Identity?.Name ?? "System";
        load.CreatedDate = DateTime.Now;
        load.Status = "Loaded";

        _context.Loads.Add(load);
        await _context.SaveChangesAsync();

        return RedirectToAction(nameof(Index));
        }

        // Helper: Populate dropdowns
        private async Task PopulateDropdowns(LoadCreateViewModel vm)
        {
        vm.Vendors = await _context.Vendors
        .OrderBy(v => v.Name)
        .Select(v => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem
        {
        Value = v.DCLink.ToString(),
        Text = $"{v.Account} - {v.Name}"
        }).ToListAsync();

        vm.StockItems = await _context.StockItems
        .OrderBy(s => s.Description_1)
        .Select(s => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem
        {
        Value = s.StockLink.ToString(),
        Text = $"{s.Code} - {s.Description_1}"
        }).ToListAsync();

        vm.Trucks = await _context.Trucks
        .Where(t => t.Status == "Active")
        .OrderBy(t => t.RegistrationNumber)
        .Select(t => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem
        {
        Value = t.idTruck.ToString(),
        Text = t.RegistrationNumber
        }).ToListAsync();

        vm.Drivers = await _context.Drivers
        .Where(d => d.Status == "Active")
        .OrderBy(d => d.FullName)
        .Select(d => new Microsoft.AspNetCore.Mvc.Rendering.SelectListItem
        {
        Value = d.idDriver.ToString(),
        Text = d.FullName
        }).ToListAsync();
        }

        // GET: Load/Index
        public async Task<IActionResult>
            Index()
            {
            var loads = await _context.Loads
            .Include(l => l.Truck)
            .Include(l => l.Driver)
            .Include(l => l.Vendor)
            .Include(l => l.StockItem)
            .ToListAsync();

            return View(loads);
            }
            }
            }
